<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBO-CON Enterprise</title>
    <style>
        :root { --primary: #00e5ff; --bg: #0b0f19; --nav: #161b2c; --text: #ffffff; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; }
        .app { max-width: 500px; margin: auto; height: 100vh; display: flex; flex-direction: column; }
        
        .screen { display: none; flex: 1; padding: 20px; overflow-y: auto; }
        .active { display: flex; flex-direction: column; }

        .nav-bar { display: none; background: var(--nav); height: 60px; justify-content: space-around; align-items: center; border-top: 1px solid #334155; }
        .nav-item { cursor: pointer; font-size: 12px; text-align: center; color: #64748b; }
        .nav-item.active-nav { color: var(--primary); font-weight: bold; }

        .card { background: #1e293b; padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        #chatBox { flex:1; background: #000; border-radius: 10px; margin-bottom: 10px; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        /* Chat Bubbles */
        .msg { padding: 8px 12px; border-radius: 12px; max-width: 80%; font-size: 14px; }
        .msg.me { background: var(--primary); color: #000; align-self: flex-end; }
        .msg.them { background: #334155; color: #fff; align-self: flex-start; }
        
        input { background: #242b42; border: 1px solid #334155; color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; outline: none; }
        button { background: var(--primary); color: #000; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="app">
    <div id="loginScreen" class="screen active">
        <h2>MBO-CONn Login</h2>
        <input type="text" id="idInput" placeholder="Email or Phone">
        <input type="password" id="passInput" placeholder="Password">
        <button onclick="handleLogin()">Login</button>
    </div>

    <div id="roomsScreen" class="screen">
        <h3>Group Rooms</h3>
        <div id="roomList"></div>
    </div>

    <div id="profilesScreen" class="screen">
        <h3>Staff Directory</h3>
        <div id="profileList"></div>
    </div>

    <div id="chatScreen" class="screen">
        <h3 id="chatPartner">Private Chat</h3>
        <div id="chatBox"></div>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="chatInput" placeholder="Type message..." style="flex:1;">
            <button onclick="sendPrivateMessage()">Send</button>
        </div>
    </div>

    <div id="navBar" class="nav-bar">
        <div class="nav-item" onclick="switchTab('roomsScreen')">ROOMS</div>
        <div class="nav-item" onclick="switchTab('profilesScreen')">PROFILES</div>
        <div class="nav-item" onclick="switchTab('chatScreen')">CHAT</div>
    </div>
</div>

<script>
   const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzF6Qv47ZWj6YbxiFYIzYp26i6lYIrhM3oOXZcq8JhO1OT_36qGXt1ybhGDBxRpkLMT/exec';
    let currentUser = null;
    let currentPartner = null;
    let refreshInterval = null;

    // Support for Enter key in chat
    document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendPrivateMessage();
    });

    async function api(payload) {
        try {
            const response = await fetch(SCRIPT_URL, {
                method: "POST",
                mode: "cors",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify(payload),
                redirect: "follow"
            });
            if (!response.ok) throw new Error('Network response was not ok');
            return await response.json();
        } catch (e) {
            console.error("API Error:", e);
            throw e;
        }
    }

    async function handleLogin() {
        const identifier = document.getElementById('idInput').value;
        const password = document.getElementById('passInput').value;
        const btn = document.querySelector('#loginScreen button');
        
        btn.innerText = "Verifying...";
        btn.disabled = true;

        try {
            const res = await api({ action: "login", identifier, password });
            if(res.status === "success") {
                currentUser = res.user;
                document.getElementById('loginScreen').classList.remove('active');
                document.getElementById('navBar').style.display = 'flex';
                switchTab('roomsScreen');
            } else { alert(res.message); }
        } catch (e) { 
            alert("Network Error: Ensure the Script is deployed to 'Anyone'."); 
        } finally {
            btn.innerText = "Login";
            btn.disabled = false;
        }
    }

    function switchTab(screenId) {
        if (refreshInterval) clearInterval(refreshInterval);
        
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');

        // Update Nav UI
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active-nav');
            if(item.innerText.toLowerCase() === screenId.replace('Screen', '')) {
                item.classList.add('active-nav');
            }
        });
        
        if(screenId === 'roomsScreen') loadRooms();
        if(screenId === 'profilesScreen') loadProfiles();
        if(screenId === 'chatScreen' && currentPartner) startRefreshingChat();
    }

    async function loadRooms() {
        try {
            const res = await api({ action: "getRooms" });
            const list = document.getElementById('roomList');
            list.innerHTML = res.rooms.map(r => `
                <div class="card">
                    <span>üè† ${r[0]}</span>
                    <button style="float:right; padding: 5px 10px;" onclick="alert('Room joined!')">Join</button>
                </div>`).join('');
        } catch(e) {}
    }

    async function loadProfiles() {
        try {
            const res = await api({ action: "getProfiles" });
            const list = document.getElementById('profileList');
            // Filter out the current user so they don't chat with themselves
            list.innerHTML = res.profiles
                .filter(p => p.phone != currentUser.phone)
                .map(p => `
                <div class="card">
                    <b>${p.name}</b><br><small style="color:var(--primary)">${p.job}</small>
                    <button onclick="startChat('${p.phone}', '${p.name}')" style="display:block; margin-top:10px; padding:5px; width:100%">Message</button>
                </div>
            `).join('');
        } catch(e) {}
    }

    function startChat(phone, name) {
        currentPartner = phone;
        document.getElementById('chatPartner').innerText = "Chat with " + name;
        switchTab('chatScreen');
    }

    function startRefreshingChat() {
        loadMessages();
        refreshInterval = setInterval(loadMessages, 3000); 
    }

    async function loadMessages() {
        if(!currentPartner || !currentUser) return;
        try {
            const res = await api({ action: "getMessages", me: currentUser.phone, partner: currentPartner });
            if(res.status === "success") {
                const chatBox = document.getElementById('chatBox');
                const oldContent = chatBox.innerHTML;
                const newContent = res.messages.map(m => `
                    <div class="msg ${m.sender == currentUser.phone ? 'me' : 'them'}">
                        ${m.text}
                        <div style="font-size:9px; opacity:0.6; margin-top:4px;">${m.time}</div>
                    </div>
                `).join('');
                
                if (oldContent !== newContent) {
                    chatBox.innerHTML = newContent;
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            }
        } catch (e) { console.error("Chat Refresh Error"); }
    }

    async function sendPrivateMessage() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if(!text || !currentPartner) return;

        const originalPlaceholder = input.placeholder;
        input.placeholder = "Sending...";
        input.value = "";
        input.disabled = true;

        try {
            await api({ action: "sendMessage", sender: currentUser.phone, receiver: currentPartner, text: text });
            loadMessages(); 
        } catch (e) { alert("Failed to send"); }
        
        input.disabled = false;
        input.placeholder = originalPlaceholder;
        input.focus();
    }
</script>
</body>
</html>
