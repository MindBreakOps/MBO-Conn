<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="manifest" href="manifest.json">
	<title>MBO-CON Enterprise</title>
	<style>
		:root { 
			--glass: rgba(255, 255, 255, 0.85); 
			--accent: #5d4037; 
			--bg: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
			--text: #1e293b;
		}
		body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; min-height: 100vh; display: flex; justify-content: center; }
		.app-container { width: 100%; max-width: 500px; padding-bottom: 80px; }

		.glass-card {
			background: var(--glass);
			backdrop-filter: blur(15px);
			-webkit-backdrop-filter: blur(15px);
			border: 1px solid rgba(255, 255, 255, 0.5);
			border-radius: 24px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
			padding: 20px;
			margin: 15px;
		}

		.screen { display: none; flex-direction: column; }
		.active { display: flex; }

		.logo-container { text-align: center; padding: 30px 0; }
		.logo-img { width: 90px; height: 90px; border-radius: 20px; }

		input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 12px; border: 1px solid #ddd; box-sizing: border-box; }
		button { width: 100%; padding: 12px; border-radius: 12px; border: none; background: var(--accent); color: white; font-weight: bold; cursor: pointer; transition: 0.2s; }
		button:active { transform: scale(0.97); }

		.nav-bar { display: none; position: fixed; bottom: 0; width: 100%; max-width: 500px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); height: 70px; border-top: 1px solid #eee; justify-content: space-around; align-items: center; z-index: 100; }
		.nav-item { cursor: pointer; text-align: center; font-size: 11px; font-weight: bold; color: #999; }
		.nav-item.active-nav { color: var(--accent); }

		.modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.2); backdrop-filter: blur(8px); z-index: 1000; justify-content: center; align-items: center; }
		.admin-only { display: none; }
	</style>
</head>
<body>

<div class="app-container">
	<div id="loginScreen" class="screen active">
		<div class="logo-container">
			<img src="mb.png" class="logo-img">
			<h2 style="color: var(--accent)">MBO-CON</h2>
		</div>
		<div class="glass-card">
			<input type="text" id="idInput" placeholder="Email or Phone">
			<input type="password" id="passInput" placeholder="Password">
			<button onclick="handleLogin()">Sign In</button>
		</div>
	</div>

	<div id="dashScreen" class="screen">
		<div class="glass-card admin-only" id="adminPanel">
			<h3>System Insights</h3>
			<div id="analyticsList" style="font-size: 12px; max-height: 100px; overflow-y: auto;"></div>
			<button onclick="openModal('memberModal')" style="margin-top:15px; background: #222;">+ New Member</button>
		</div>
		<div class="glass-card">
			<h3>Staff Members</h3>
			<div id="profileList"></div>
		</div>
	</div>

	<div id="roomsScreen" class="screen">
		<div class="glass-card">
			<h3>Group Rooms</h3>
			<div id="roomList"></div>
			<button class="admin-only" id="createRoomBtn" onclick="openRoomModal()" style="margin-top:20px">+ Create Room</button>
		</div>
	</div>

	<div id="chatScreen" class="screen">
		<h3 id="chatPartner" style="margin: 20px;">Private Chat</h3>
		<div id="chatBox" class="glass-card" style="height: 400px; overflow-y: auto; background: rgba(255,255,255,0.4)"></div>
		<div class="glass-card" style="display: flex; gap: 10px;">
			<input type="text" id="chatInput" placeholder="Message..." style="margin:0">
			<button onclick="sendPrivateMessage()" style="width: 80px;">Send</button>
		</div>
	</div>

	<div id="navBar" class="nav-bar">
		<div class="nav-item active-nav" onclick="switchTab('dashScreen')">DASHBOARD</div>
		<div class="nav-item" onclick="switchTab('roomsScreen')">ROOMS</div>
		<div class="nav-item" onclick="switchTab('chatScreen')">CHAT</div>
	</div>
</div>

<div id="memberModal" class="modal-overlay">
	<div class="glass-card" style="width: 85%;">
		<h3>New Employee</h3>
		<input type="text" id="newName" placeholder="Full Name">
		<input type="email" id="newEmail" placeholder="Email">
		<input type="password" id="newPass" placeholder="Password">
		<input type="text" id="newJob" placeholder="Job Title">
		<input type="text" id="newPhone" placeholder="Phone">
		<select id="newType"><option value="Staff">Staff</option><option value="Admin">Admin</option></select>
		<button onclick="submitNewMember()">Save Member</button>
		<button onclick="closeModal('memberModal')" style="background:#eee; color:#333; margin-top:5px">Cancel</button>
	</div>
</div>

<div id="roomModal" class="modal-overlay">
	<div class="glass-card" style="width: 85%;">
		<h3>Configure Room</h3>
		<input type="text" id="roomNameInput" placeholder="Room Name">
		<div id="memberChecklist" style="max-height: 150px; overflow-y: auto; margin-bottom: 10px;"></div>
		<button onclick="submitNewRoom()">Create Room</button>
		<button onclick="closeModal('roomModal')" style="background:#eee; color:#333; margin-top:5px">Cancel</button>
	</div>
</div>

<script>
	const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby559vm7yVTLxfZT9OqU4BjRVwVwbtwCIpwbHa9wKFWcHtTgCfhJf7GrS5QgVympO5B/exec';
	let currentUser = null;
	let currentPartner = null;
	
	// 1. Core API Handler
	async function api(payload) {
		try {
			const response = await fetch(SCRIPT_URL, {
				method: "POST",
				mode: "cors", 
				headers: { "Content-Type": "text/plain;charset=utf-8" },
				body: JSON.stringify(payload),
				redirect: "follow"
			});
			if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
			return await response.json();
		} catch (e) {
			console.error("Fetch Error:", e);
			throw e;
		}
	}
	
	// 2. Login Function (Now correctly wrapped)
	async function handleLogin() {
		const idField = document.getElementById('idInput');
		const passField = document.getElementById('passInput');
		const loginBtn = document.querySelector('#loginScreen button');
	
		if (!idField.value || !passField.value) {
			alert("Please enter credentials");
			return;
		}
	
		// UI Feedback
		loginBtn.innerText = "Connecting...";
		loginBtn.disabled = true;
	
		try {
			const res = await api({ 
				action: "login", 
				identifier: idField.value, 
				password: passField.value 
			});
	
			if (res && res.status === "success") {
				currentUser = res.user;
				
				// UI Transitions
				document.getElementById('loginScreen').classList.remove('active');
				document.getElementById('navBar').style.display = 'flex';
				
				// Check for Admin Permissions (Asim)
				const isAsim = currentUser.email === "asim@mbo.sa" || currentUser.name.toLowerCase().includes("asim");
				if (isAsim) {
					document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'block');
					loadAnalytics();
				}
				
				switchTab('dashScreen');
			} else {
				alert(res.message || "Invalid Login Credentials");
				loginBtn.innerText = "Sign In";
				loginBtn.disabled = false;
			}
		} catch (e) {
			alert("Connection Error. Check if your Script is deployed to 'Anyone'.");
			loginBtn.innerText = "Sign In";
			loginBtn.disabled = false;
		}
	}
	
	// 3. Navigation
	function switchTab(id) {
		document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
		document.getElementById(id).classList.add('active');
		
		// Update Nav bar visual state
		document.querySelectorAll('.nav-item').forEach(item => {
			item.classList.remove('active-nav');
			if(id.includes(item.innerText.toLowerCase())) {
				item.classList.add('active-nav');
			}
		});
	
		if(id === 'dashScreen') loadProfiles();
		if(id === 'roomsScreen') loadRooms();
	}
	
	// 4. Directory & Profiles
	async function loadProfiles() {
		try {
			const res = await api({ action: "getProfiles" });
			const list = document.getElementById('profileList');
			list.innerHTML = res.profiles.map(p => `
				<div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
					<div><b>${p.name}</b><br><small>${p.job}</small></div>
					<button style="width:auto; padding:5px 15px" onclick="startChat('${p.phone}', '${p.name}')">Chat</button>
				</div>
			`).join('');
		} catch(e) { console.error("Profile load failed"); }
	}
	
	// 5. Room Management
	async function loadRooms() {
		try {
			const res = await api({ action: "getRooms" });
			const list = document.getElementById('roomList');
			list.innerHTML = res.rooms.map(r => `
				<div class="glass-card" style="margin:10px 0;">
					üè† <b>${r[0]}</b><br><small>Members: ${r[1]}</small>
				</div>
			`).join('');
		} catch(e) { console.error("Room load failed"); }
	}
	
	async function submitNewRoom() {
		const name = document.getElementById('roomNameInput').value;
		const members = Array.from(document.querySelectorAll('.room-mem:checked')).map(c => c.value);
		if(!name) return alert("Enter room name");
		
		await api({ action: "createRoom", roomName: name, members: members });
		closeModal('roomModal');
		loadRooms();
	}
	
	// 6. Member Management (Asim Only)
	async function submitNewMember() {
		const payload = {
			action: "addMember",
			newName: document.getElementById('newName').value,
			newEmail: document.getElementById('newEmail').value,
			newPass: document.getElementById('newPass').value,
			newJob: document.getElementById('newJob').value,
			newPhone: document.getElementById('newPhone').value,
			newType: document.getElementById('newType').value
		};
		await api(payload);
		closeModal('memberModal');
		loadProfiles();
	}
	
	async function loadAnalytics() {
		try {
			const res = await api({ action: "getAnalytics" });
			const list = document.getElementById('analyticsList');
			list.innerHTML = res.recentLogs.map(log => `
				<div style="border-bottom:1px solid #eee; padding:5px 0">
					<small>${log.time}</small> | ${log.from} ‚ûî ${log.to}
				</div>
			`).join('');
		} catch(e) {}
	}
	
	// 7. Modal Controls
	function openModal(id) { 
		document.getElementById(id).style.display = 'flex'; 
		if(id === 'roomModal') loadMemberChecklist(); 
	}
	function closeModal(id) { document.getElementById(id).style.display = 'none'; }
	
	async function loadMemberChecklist() {
		const res = await api({ action: "getProfiles" });
		const list = document.getElementById('memberChecklist');
		list.innerHTML = res.profiles.map(p => `
			<label style="display:block; padding:5px;">
				<input type="checkbox" class="room-mem" value="${p.name}"> ${p.name}
			</label>
		`).join('');
	}
	
	// 8. Chat Logic
	function startChat(phone, name) {
		currentPartner = phone;
		document.getElementById('chatPartner').innerText = "Chat with " + name;
		switchTab('chatScreen');
		loadMessages();
	}
	
	async function loadMessages() {
		if(!currentPartner) return;
		const res = await api({ action: "getMessages", me: currentUser.phone, partner: currentPartner });
		const box = document.getElementById('chatBox');
		box.innerHTML = res.messages.map(m => `
			<div style="text-align:${m.sender == currentUser.phone ? 'right':'left'}; margin-bottom:10px;">
				<div style="display:inline-block; padding:10px; border-radius:15px; background:${m.sender == currentUser.phone ? '#5d4037':'#eee'}; color:${m.sender == currentUser.phone ? 'white':'black'}">
					${m.text}
				</div>
				<br><small style="font-size:10px; color:#999;">${m.time}</small>
			</div>
		`).join('');
		box.scrollTop = box.scrollHeight;
	}
</script>
</body>
</html>
