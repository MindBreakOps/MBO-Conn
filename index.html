<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>MBO-CON Enterprise</title>
	<script src="https://unpkg.com/lucide@latest"></script>
	<style>
		:root { --glass: rgba(255, 255, 255, 0.9); --accent: #5d4037; --bg: #f4f7f6; }
		body { background: var(--bg); font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; justify-content: center; }
		.app-container { width: 100%; max-width: 500px; min-height: 100vh; padding-bottom: 80px; position: relative; }
		.glass-card { background: var(--glass); backdrop-filter: blur(10px); border-radius: 20px; padding: 20px; margin: 15px; border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
		.screen { display: none; } .active { display: block; }
		.nav-bar { display: none; position: fixed; bottom: 0; width: 100%; max-width: 500px; background: white; height: 70px; border-top: 1px solid #eee; justify-content: space-around; align-items: center; z-index: 100; }
		.nav-item { cursor: pointer; text-align: center; font-size: 10px; font-weight: bold; color: #999; display: flex; flex-direction: column; align-items: center; gap: 4px; }
		.active-nav { color: var(--accent); }
		input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; }
		button { width: 100%; padding: 12px; border-radius: 10px; border: none; background: var(--accent); color: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
		.admin-only { display: none; }
		#chatBox { height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding: 10px; }
		.msg { padding: 10px; border-radius: 15px; max-width: 85%; font-size: 14px; }
		.sent { background: var(--accent); color: white; align-self: flex-end; }
		.received { background: #e9ecef; color: #333; align-self: flex-start; }
		.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1000; justify-content: center; align-items: center; }
		.lucide { width: 20px; height: 20px; }
	</style>
</head>
<body>

<div class="app-container">
	<div id="loginScreen" class="screen active">
		<div class="glass-card" style="text-align:center; margin-top:50px">
			<img src="mb.png" style="width:80px; border-radius:15px; margin-bottom:10px">
			<h2>MBO-CON</h2>
			<input type="text" id="idInput" placeholder="Email or Phone">
			<input type="password" id="passInput" placeholder="Password">
			<button onclick="handleLogin()">Sign In <i data-lucide="log-in"></i></button>
		</div>
	</div>

	<div id="dashScreen" class="screen">
		<div class="glass-card admin-only">
			<h3 style="margin:0; display:flex; align-items:center; gap:8px"><i data-lucide="shield-check"></i> Manager Insights</h3>
			<div id="analyticsList" style="max-height:120px; overflow:auto; font-size:12px; margin:10px 0"></div>
			<button onclick="openModal('memberModal')" style="background:#222"><i data-lucide="user-plus"></i> Register Member</button>
		</div>
		<div class="glass-card">
			<h3 style="display:flex; align-items:center; gap:8px"><i data-lucide="users"></i> Staff Members</h3>
			<div id="profileList"></div>
		</div>
	</div>

	<div id="roomsScreen" class="screen">
		<div class="glass-card">
			<h3 style="display:flex; align-items:center; gap:8px"><i data-lucide="layout-grid"></i> Group Rooms</h3>
			<div id="roomList"></div>
			<button class="admin-only" onclick="openModal('roomModal')" style="margin-top:10px"><i data-lucide="plus-square"></i> Create Room</button>
		</div>
	</div>

	<div id="profileScreen" class="screen">
		<div class="glass-card" style="text-align:center">
			<div style="width:70px; height:70px; background:var(--accent); color:white; border-radius:50%; margin:0 auto 10px; display:flex; align-items:center; justify-content:center; font-size:24px" id="pInit">U</div>
			<h2 id="pName" style="margin:0">User</h2>
			<p id="pJob" style="color:#777">Job</p>
			<div style="text-align:left; font-size:14px; margin-top:20px; border-top:1px solid #eee; padding-top:10px">
				<p style="display:flex; align-items:center; gap:8px"><i data-lucide="mail"></i> <span id="pEmail"></span></p>
				<p style="display:flex; align-items:center; gap:8px"><i data-lucide="phone"></i> <span id="pPhone"></span></p>
			</div>
			<button onclick="location.reload()" style="background:#c62828; margin-top:20px"><i data-lucide="log-out"></i> Sign Out</button>
		</div>
	</div>

	<div id="chatScreen" class="screen">
		<div class="glass-card">
			<div style="display:flex; align-items:center; justify-content:space-between">
				<h3 id="chatHeader" style="margin:0">Chat</h3>
				<button onclick="switchTab('dashScreen')" style="width:auto; padding:5px; background:#eee; color:#333"><i data-lucide="x"></i></button>
			</div>
			<div id="chatBox"></div>
			<div style="display:flex; gap:10px; margin-top:10px">
				<input type="text" id="chatInput" placeholder="Type..." style="margin:0">
				<button onclick="sendMsg()" style="width:80px"><i data-lucide="send"></i></button>
			</div>
		</div>
	</div>

	<div id="navBar" class="nav-bar">
		<div class="nav-item active-nav" onclick="switchTab('dashScreen')"><i data-lucide="home"></i>HOME</div>
		<div class="nav-item" onclick="switchTab('roomsScreen')"><i data-lucide="message-square"></i>ROOMS</div>
		<div class="nav-item" onclick="switchTab('profileScreen')"><i data-lucide="user"></i>PROFILE</div>
	</div>
</div>

<div id="memberModal" class="modal"><div class="glass-card" style="width:85%">
	<h3>Add Employee</h3>
	<input id="nName" placeholder="Name"><input id="nEmail" placeholder="Email"><input id="nPass" placeholder="Pass"><input id="nJob" placeholder="Job"><input id="nPhone" placeholder="Phone">
	<select id="nType"><option value="Staff">Staff</option><option value="Admin">Admin</option></select>
	<button onclick="submitNewMember()">Save Member</button><button onclick="closeModal('memberModal')" style="background:#ccc; margin-top:5px">Cancel</button>
</div></div>

<div id="roomModal" class="modal"><div class="glass-card" style="width:85%">
	<h3>New Group Room</h3>
	<input id="rName" placeholder="Room Name">
	<div id="mCheck" style="max-height:100px; overflow:auto; margin-bottom:10px"></div>
	<button onclick="submitNewRoom()">Build Room</button><button onclick="closeModal('roomModal')" style="background:#ccc; margin-top:5px">Cancel</button>
</div></div>

<script>
	const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwrdU2yv6D7s0Nkw4EUBcHU4ryel8MdiIh87n8BBZthwSZyIVX5OhccZ2Qc4qUfvUk/exec';
	let user = null; let partner = null; let isRoom = false; let chatInterval;

	function api(p) {
		return new Promise((res) => {
			const cb = 'cb'+Math.round(Math.random()*100000);
			window[cb] = (d) => { res(d); delete window[cb]; };
			const s = document.createElement('script');
			s.src = `${SCRIPT_URL}?${new URLSearchParams(p)}&callback=${cb}`;
			document.body.appendChild(s);
		});
	}

	async function handleLogin() {
		const res = await api({ action: "login", identifier: idInput.value, password: passInput.value });
		if(res.status === "success") {
			user = res.user;
			loginScreen.classList.remove('active'); navBar.style.display = 'flex';
			if(user.name.toLowerCase().includes("asim")) {
				document.querySelectorAll('.admin-only').forEach(e => e.style.display='block');
				loadAnalytics();
			}
			setupProfile(); switchTab('dashScreen');
			lucide.createIcons(); // Initialize Icons
		} else alert("Invalid Login");
	}

	function setupProfile() {
		pName.innerText = user.name; pJob.innerText = user.job; pEmail.innerText = user.email;
		pPhone.innerText = user.phone; pInit.innerText = user.name[0];
	}

	async function loadAnalytics() {
		const res = await api({ action: "getAnalytics" });
		analyticsList.innerHTML = res.recentLogs.map(l => `
			<div style="border-bottom:1px solid #eee; padding:6px; position:relative">
				<b>${l.from}</b> to <b>${l.to}</b><br><small style="color:#666">"${l.text}"</small>
				<button onclick="openPeek('${l.from}','${l.to}')" style="position:absolute; right:0; top:5px; width:auto; padding:2px 8px; font-size:10px">View</button>
			</div>
		`).join('');
	}

	function openPeek(p1, p2) {
		partner = (p1 === user.name) ? p2 : p1; isRoom = false;
		chatHeader.innerText = "Audit: " + p1 + " & " + p2;
		switchTab('chatScreen');
	}

	async function loadProfiles() {
		const res = await api({ action: "getProfiles" });
		profileList.innerHTML = res.profiles.map(p => `
			<div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #eee">
				<div><b>${p.name}</b><br><small>${p.job}</small></div>
				<button onclick="startChat('${p.name}')" style="width:auto; padding:5px 15px">Chat</button>
			</div>
		`).join('');
	}

	async function loadRooms() {
		const res = await api({ action: "getRooms" });
		roomList.innerHTML = res.rooms.map(r => `
			<div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #eee">
				<div><b>${r[0]}</b></div>
				<button onclick="startRoom('${r[0]}')" style="width:auto; padding:5px 15px; background:#222">Open</button>
			</div>
		`).join('');
	}

	function startChat(n) { partner = n; isRoom = false; chatHeader.innerText = n; switchTab('chatScreen'); }
	function startRoom(n) { partner = n; isRoom = true; chatHeader.innerText = n; switchTab('chatScreen'); }

	async function sendMsg() {
		const t = chatInput.value; if(!t) return; chatInput.value = "";
		await api({ action: "sendMessage", sender: user.name, receiver: partner, text: t, isRoom: isRoom });
		loadMessages();
	}

	async function loadMessages() {
		if(!partner) return;
		const res = await api({ action: "getMessages", me: user.name, partner: partner, isRoom: isRoom });
		chatBox.innerHTML = res.messages.map(m => `
			<div class="msg ${m.sender === user.name ? 'sent' : 'received'}">
				<small style="display:block; font-size:10px; opacity:0.6">${m.sender}</small>${m.text}
			</div>
		`).join('');
		chatBox.scrollTop = chatBox.scrollHeight;
	}

	function switchTab(id) {
		clearInterval(chatInterval);
		document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
		document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active-nav'));
		document.getElementById(id).classList.add('active');
		
		if(id === 'dashScreen') { loadProfiles(); document.querySelectorAll('.nav-item')[0].classList.add('active-nav'); }
		if(id === 'roomsScreen') { loadRooms(); document.querySelectorAll('.nav-item')[1].classList.add('active-nav'); }
		if(id === 'profileScreen') document.querySelectorAll('.nav-item')[2].classList.add('active-nav');
		if(id === 'chatScreen') { loadMessages(); chatInterval = setInterval(loadMessages, 3000); }
		
		lucide.createIcons();
	}

	function openModal(id) { document.getElementById(id).style.display = 'flex'; if(id === 'roomModal') loadCheck(); }
	function closeModal(id) { document.getElementById(id).style.display = 'none'; }

	async function loadCheck() {
		const res = await api({ action: "getProfiles" });
		mCheck.innerHTML = res.profiles.map(p => `<label style="display:block; margin:5px 0"><input type="checkbox" class="mc" value="${p.name}"> ${p.name}</label>`).join('');
	}

	async function submitNewMember() {
		await api({ action: "addMember", newName: nName.value, newEmail: nEmail.value, newPass: nPass.value, newJob: nJob.value, newPhone: nPhone.value, newType: nType.value });
		closeModal('memberModal'); loadProfiles();
	}

	async function submitNewRoom() {
		const m = Array.from(document.querySelectorAll('.mc:checked')).map(c => c.value).join(',');
		await api({ action: "createRoom", roomName: rName.value, members: m });
		closeModal('roomModal'); loadRooms();
	}
</script>
</body>
</html>
