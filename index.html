<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>MBO-CON</title>
	<script src="https://unpkg.com/lucide@latest"></script>
	<style>
		:root {
			--ios-blue: #007AFF;
			--ios-grey: #E9E9EB;
			--ios-dark-grey: #8E8E93;
			--ios-green: #34C759;
			--glass: rgba(255, 255, 255, 0.7);
		}

		* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

		body, html {
			height: 100%; margin: 0; overflow: hidden;
			font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
			background: linear-gradient(135deg, #a2c2e1 0%, #ffffff 100%);
		}

		.app-container { height: 100vh; display: flex; flex-direction: column; position: relative; }

		/* Screens */
		.screen { display: none; flex: 1; overflow-y: auto; padding-bottom: 100px; }
		.screen.active { display: block; }

		/* Liquid Glass Card */
		.glass-card {
			background: var(--glass);
			backdrop-filter: blur(30px) saturate(190%);
			-webkit-backdrop-filter: blur(30px) saturate(190%);
			border: 1px solid rgba(255, 255, 255, 0.4);
			border-radius: 20px; margin: 15px; padding: 20px;
			box-shadow: 0 8px 32px rgba(0,0,0,0.05);
		}

		/* iMessage Chat Overlay - FULL HEIGHT FIX */
		#chatScreen {
			display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
			background: white; z-index: 1000; flex-direction: column;
		}

		.chat-header {
			background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px);
			padding: 10px 15px; display: flex; align-items: center; justify-content: space-between;
			border-bottom: 0.5px solid #ddd; height: 65px;
		}

		#chatBox { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; background: #fff; }

		.chat-input-bar {
			background: rgba(248, 248, 248, 0.96); backdrop-filter: blur(20px);
			padding: 10px 15px 35px; display: flex; align-items: center; gap: 10px;
			border-top: 0.5px solid #ddd; width: 100%;
		}
		#chatInput {
			flex: 1;
			background: white;
			border: 1px solid #ddd;
			padding: 10px 15px;
			border-radius: 20px;
			font-size: 16px;
			font-family: inherit;
			resize: none; /* Disables the drag corner */
			max-height: 120px; /* Prevents it from taking over the whole screen */
			line-height: 1.4;
			outline: none;
			transition: height 0.1s ease;
		}

		/* Bubbles */
		.msg { max-width: 75%; padding: 10px 16px; border-radius: 20px; font-size: 16px; margin-bottom: 8px; position: relative; }
		.msg.sent { background: var(--ios-blue); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
		.msg.received { background: var(--ios-grey); color: black; align-self: flex-start; border-bottom-left-radius: 4px; }
		.msg img { max-width: 100%; border-radius: 12px; margin-top: 8px; }
		.msg audio { width: 100%; height: 35px; margin-top: 5px; }

		/* Navigation */
		.nav-bar {
			position: fixed; bottom: 0; width: 100%; height: 85px;
			display: none; justify-content: space-around; align-items: center;
			background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px);
			border-top: 0.5px solid #ddd; z-index: 500; padding-bottom: 15px;
		}
		.nav-item { color: var(--ios-dark-grey); text-align: center; font-size: 10px; font-weight: 600; cursor: pointer; }
		.nav-item.active-nav { color: var(--ios-blue); }

		/* Admin/General Elements */
		input[type="text"], input[type="password"], input[type="email"] {
			width: 100%; padding: 14px; border-radius: 12px; border: none;
			background: rgba(0,0,0,0.06); font-size: 16px; outline: none; margin-top: 8px;
		}
		
		.call-btn { background: var(--ios-green); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
		
		/* Spinner for Sign In */
		.spinner {
			display: none; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3);
			border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-left: 10px;
		}
		@keyframes spin { to { transform: rotate(360deg); } }
		
		button.primary-btn {
			width: 100%; background: var(--ios-blue); color: white; border: none; 
			padding: 15px; border-radius: 14px; font-weight: 600; font-size: 16px;
			display: flex; align-items: center; justify-content: center; cursor: pointer;
		}
	</style>
</head>
<body>

<div class="app-container">
	<div id="loginScreen" class="screen active">
		<div class="glass-card" style="margin-top: 100px; text-align: center;">
			<img src="mb.png" style="width:80px; border-radius:20px; margin-bottom:15px">
			<h2 style="letter-spacing:-1px">MBO-CON</h2>
			<input type="text" id="idInput" placeholder="Email or Phone">
			<input type="password" id="passInput" placeholder="Password">
			<button class="primary-btn" id="loginBtn" onclick="handleLogin()">
				<span>Sign In</span>
				<div class="spinner" id="loginSpinner"></div>
			</button>
		</div>
	</div>

	<div id="dashScreen" class="screen">
		<div class="glass-card">
			<h3 style="margin:0"><i data-lucide="search" style="width:18px"></i> Find Contact</h3>
			<input type="text" id="contactSearch" placeholder="Type a name..." oninput="filterContacts()">
			<div id="searchResults" style="margin-top:10px;"></div>
		</div>
		<div id="notificationArea" style="padding: 0 15px;"></div>
	</div>

	<div id="adminScreen" class="screen">
		<div class="glass-card">
			<h3>Admin Dash</h3>
			<div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
				<button onclick="openModal('memberModal')" style="background:#000; color:white; border-radius:10px; padding:12px; border:none;">+ Staff</button>
				<button onclick="openModal('roomModal')" style="background:#000; color:white; border-radius:10px; padding:12px; border:none;">+ Room</button>
			</div>
			<h4 style="margin-top:20px">Directory</h4>
			<div id="adminUserList"></div>
			<h4 style="margin-top:20px">Active Rooms</h4>
			<div id="adminRoomList"></div>
		</div>
	</div>

	<div id="roomsScreen" class="screen">
		<div class="glass-card">
			<h3>Group Rooms</h3>
			<div id="roomList"></div>
		</div>
	</div>

	<div id="profileScreen" class="screen">
		<div class="glass-card" style="text-align:center">
			<div id="pInit" style="width:90px; height:90px; background:var(--ios-blue); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px; font-size:36px; font-weight:bold;">U</div>
			<h2 id="pName" style="margin:0">Name</h2>
			<p id="pJob" style="color:var(--ios-dark-grey)">Position</p>
			<div style="display:flex; justify-content:center; gap:20px; margin: 25px 0;">
				<button onclick="makePhoneCall()" class="call-btn" style="width:60px; height:60px;"><i data-lucide="phone" style="width:28px; height:28px"></i></button>
			</div>
			<button onclick="location.reload()" style="width:100%; background:#ff3b30; color:white; border:none; padding:15px; border-radius:12px; font-weight:600;">Sign Out</button>
		</div>
	</div>

	<div id="chatScreen">
		<div class="chat-header">
			<div style="display:flex; align-items:center">
				<button onclick="closeChat()" style="background:none; border:none; padding:5px;"><i data-lucide="chevron-left" style="color:var(--ios-blue)"></i></button>
				<div style="margin-left:10px">
					<b id="chatHeader" style="font-size:17px;">Name</b>
					<div id="chatHeaderStatus" style="font-size:11px; color:var(--ios-dark-grey)">Online</div>
				</div>
			</div>
			<button id="headerCallBtn" class="call-btn" onclick="makePhoneCall()"><i data-lucide="phone" style="width:18px"></i></button>
		</div>
		
		<div id="chatBox"></div>
	
		<div class="chat-input-bar">
			<input type="file" id="fileInput" onchange="handleFileUpload(this)" style="display:none">
			<button onclick="document.getElementById('fileInput').click()" style="background:none; border:none; color:var(--ios-blue)"><i data-lucide="plus"></i></button>
			
			<textarea id="chatInput" placeholder="iMessage" rows="1" oninput="autoExpand(this)"></textarea>
			
			<button id="voiceBtn" style="background:none; border:none; color:var(--ios-dark-grey)"><i data-lucide="mic"></i></button>
			<button onclick="sendMsg()" style="background:none; border:none; color:var(--ios-blue)"><i data-lucide="arrow-up-circle" style="width:32px; height:32px"></i></button>
		</div>
	</div>

	<div id="navBar" class="nav-bar">
		<div class="nav-item active-nav" onclick="switchTab('dashScreen')"><i data-lucide="home"></i><div>Home</div></div>
		<div class="nav-item" onclick="switchTab('roomsScreen')"><i data-lucide="message-square"></i><div>Rooms</div></div>
		<div class="nav-item admin-only" id="navAdmin" style="display:none" onclick="switchTab('adminScreen')"><i data-lucide="shield"></i><div>Admin</div></div>
		<div class="nav-item" onclick="switchTab('profileScreen')"><i data-lucide="user"></i><div>Profile</div></div>
	</div>
</div>

<div id="memberModal" class="modal" style="position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.4); display:none; align-items:center; justify-content:center; z-index:2000;">
	<div class="glass-card" style="width:90%">
		<h3>Add Staff</h3>
		<input type="text" id="newStaffName" placeholder="Name">
		<input type="email" id="newStaffEmail" placeholder="Email">
		<input type="password" id="newStaffPass" placeholder="Password">
		<input type="text" id="newStaffJob" placeholder="Job Title">
		<input type="text" id="newStaffPhone" placeholder="Phone">
		<button class="primary-btn" onclick="saveStaff()" style="margin-top:15px">Create</button>
		<button onclick="closeModal('memberModal')" style="width:100%; border:none; background:none; margin-top:10px; color:red">Cancel</button>
	</div>
</div>
<script>
	const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby37zrYJOvnwyiiyxQ4KlctkCNRdxma1ZkKgXpjQ441siFkjL67gU58nH4O7iJQ_Z3y/exec'; 
	let user = null, partner = null, isRoom = false, allContacts = [], chatInterval, notifInterval;
	let mediaRecorder, audioChunks = [], stream;

	// --- CORE API BRIDGE ---
	async function api(p) {
		// Use POST for sending messages (handles large media strings)
		if (p.action === "sendMessage" || p.action === "addStaff") {
			const r = await fetch(SCRIPT_URL, { 
				method: "POST", 
				body: JSON.stringify(p),
				headers: { "Content-Type": "text/plain;charset=utf-8" } 
			});
			return await r.json();
		}
		// Use JSONP for GET requests to bypass CORS issues with Google Apps Script
		return new Promise(res => {
			const cb = 'cb'+Math.round(Math.random()*100000);
			window[cb] = d => { res(d); delete window[cb]; };
			const s = document.createElement('script');
			s.src = `${SCRIPT_URL}?${new URLSearchParams(p)}&callback=${cb}`;
			document.body.appendChild(s);
		});
	}

	// --- AUTHENTICATION ---
	async function handleLogin() {
		const idVal = document.getElementById('idInput').value;
		const passVal = document.getElementById('passInput').value;
		
		if(!idVal || !passVal) return alert("Please enter credentials");

		const res = await api({ action: "login", identifier: idVal, password: passVal });
		
		if(res.status === "success") {
			user = res.user;
			setupProfile();
			
			// UI Transition
			document.getElementById('loginScreen').classList.remove('active');
			document.getElementById('navBar').style.display = 'flex';
			
			// Show Admin elements if user is Asim
			if(user.name.toLowerCase().includes("asim")) {
				document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'flex');
			}
			
			switchTab('dashScreen');
			loadProfiles();
			startHeartbeat(); 
			notifInterval = setInterval(checkNotifications, 5000);
		} else {
			alert("Invalid Login. Please check your credentials.");
		}
	}

	// --- NAVIGATION & UI ---
	function switchTab(id) {
		document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
		document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active-nav'));
		
		const targetScreen = document.getElementById(id);
		if (targetScreen) targetScreen.classList.add('active');
		
		// Data Loading Triggers
		if (id === 'adminScreen') loadAdminPanel();
		else if (id === 'roomsScreen') loadRooms();
		else if (id === 'dashScreen') loadProfiles();
		
		// Update Nav Highlighting
		const tabMap = { 'dashScreen': 0, 'roomsScreen': 1, 'adminScreen': 2, 'profileScreen': 3 };
		const idx = tabMap[id];
		if (idx !== undefined) {
			const navItems = document.querySelectorAll('.nav-item');
			if (navItems[idx]) navItems[idx].classList.add('active-nav');
		}
		
		if (window.lucide) lucide.createIcons();
	}

	function setupProfile() {
		document.getElementById('pName').innerText = user.name;
		document.getElementById('pJob').innerText = user.job;
		if(document.getElementById('pInit')) document.getElementById('pInit').innerText = user.name[0];
	}

	// --- ADMIN PANEL ---
	async function loadAdminPanel() {
		const userListDiv = document.getElementById('adminUserList');
		const roomListDiv = document.getElementById('adminRoomList');
		
		userListDiv.innerHTML = "<small>Loading directory...</small>";
		roomListDiv.innerHTML = "<small>Loading rooms...</small>";

		const resProfiles = await api({ action: "getProfiles" });
		const resRooms = await api({ action: "getRooms" });

		if (resProfiles.profiles) {
			userListDiv.innerHTML = resProfiles.profiles.map(p => `
				<div class="glass-card" style="margin:5px 0; padding:10px; display:flex; justify-content:space-between; align-items:center;">
					<div><b>${p.name}</b><br><small>${p.job}</small></div>
					<button onclick="deleteUser('${p.name}')" style="background:#ff3b30; color:white; padding:5px; border-radius:8px;">
						<i data-lucide="trash-2" style="width:14px"></i>
					</button>
				</div>`).join('');
		}

		if (resRooms.rooms) {
			roomListDiv.innerHTML = resRooms.rooms.map(r => `
				<div class="glass-card" style="margin:5px 0; padding:10px; display:flex; justify-content:space-between; align-items:center;">
					<div><b>${r.name}</b></div>
					<button onclick="deleteRoom('${r.name}')" style="background:#ff3b30; color:white; padding:5px; border-radius:8px;">
						<i data-lucide="trash-2" style="width:14px"></i>
					</button>
				</div>`).join('');
		}
		lucide.createIcons();
	}

	// --- CHAT SYSTEM ---
	async function loadProfiles() { 
		const res = await api({ action: "getProfiles" }); 
		allContacts = res.profiles; 
	}

	function filterContacts() {
		const q = document.getElementById('contactSearch').value.toLowerCase();
		const resDiv = document.getElementById('searchResults');
		if(q.length < 1) { resDiv.style.display = 'none'; return; }
		const filtered = allContacts.filter(p => p.name.toLowerCase().includes(q) && p.name !== user.name);
		resDiv.style.display = 'flex';
		resDiv.innerHTML = filtered.map(p => `
			<div class="glass-card" onclick="startChat('${p.name.replace(/'/g, "\\'")}')" style="margin:5px 0; cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
				<div><b>${p.name}</b><br><small>${p.job}</small></div>
				<i data-lucide="chevron-right" style="color:#ccc"></i>
			</div>`).join('');
		lucide.createIcons();
	}

	function startChat(name, isRm = false) {
		partner = name; 
		isRoom = isRm;
		document.getElementById('chatHeader').innerText = name;
		document.getElementById('chatScreen').style.display = 'flex';
		
		const callBtn = document.getElementById('headerCallBtn');
		callBtn.style.display = isRoom ? 'none' : 'flex';
	
		loadMessages();
		clearInterval(chatInterval);
		chatInterval = setInterval(loadMessages, 3000);
	}
	function autoExpand(el) {
		el.style.height = 'auto';
		el.style.height = (el.scrollHeight) + 'px';
	}

	function closeChat() { 
		document.getElementById('chatScreen').style.display = 'none'; 
		partner = null; 
		clearInterval(chatInterval); 
	}

	// 2. Load Messages without the "Jump"
	async function loadMessages() {
		if(!partner) return;
		const res = await api({ action: "getMessages", me: user.name, partner: partner, isRoom: isRoom });
		
		const chatBox = document.getElementById('chatBox');
		
		// Check if user is currently scrolled to the bottom
		const isAtBottom = chatBox.scrollHeight - chatBox.clientHeight <= chatBox.scrollTop + 50;
	
		// Build the new HTML
		const newHTML = res.messages.map(m => `
			<div class="msg ${m.sender === user.name ? 'sent' : 'received'}">
				${isRoom ? `<small style="display:block; font-size:9px; opacity:0.6">${m.sender}</small>` : ''}
				<div>${m.text.replace(/\n/g, '<br>')}</div>
				${m.media ? (m.media.includes('audio') ? `<audio controls src="${m.media}"></audio>` : `<img src="${m.media}">`) : ''}
			</div>`).join('');
	
		// Only update the DOM if the content has actually changed (stops the blink)
		if (chatBox.innerHTML !== newHTML) {
			chatBox.innerHTML = newHTML;
			// Only force scroll if the user was already at the bottom
			if (isAtBottom) {
				chatBox.scrollTop = chatBox.scrollHeight;
			}
		}
	}

	async function loadRooms() {
		const roomListDiv = document.getElementById('roomList');
		const res = await api({ action: "getRooms" });
		if (res.status === "success" && res.rooms) {
			roomListDiv.innerHTML = res.rooms.map(r => `
				<div class="glass-card" onclick="startChat('${r.name.replace(/'/g, "\\'")}', true)" style="margin:5px 0; cursor:pointer; display:flex; justify-content:space-between;">
					<div><b>${r.name}</b><br><small>${r.desc || ''}</small></div>
					<i data-lucide="users" style="color:var(--ios-blue)"></i>
				</div>`).join('');
		}
		lucide.createIcons();
	}

	// 3. Updated Send Function to reset the height
	async function sendMsg() {
		const inp = document.getElementById('chatInput');
		const t = inp.value.trim(); 
		if(!t) return; 
		
		inp.value = "";
		inp.style.height = 'auto'; // Reset text box size
		
		await api({ action: "sendMessage", sender: user.name, receiver: partner, text: t, isRoom: isRoom });
		loadMessages();
	}

	function makePhoneCall() {
		if (!partner) return;
		const contactData = allContacts.find(c => c.name === partner);
		if (contactData && contactData.phone) window.location.href = `tel:${contactData.phone}`;
		else alert("No phone number found.");
	}

	// --- VOICE RECORDING ---
	async function startRecording() {
		try {
			stream = await navigator.mediaDevices.getUserMedia({ audio: true });
			mediaRecorder = new MediaRecorder(stream);
			audioChunks = [];
			mediaRecorder.ondataavailable = ev => audioChunks.push(ev.data);
			mediaRecorder.onstop = async () => {
				const blob = new Blob(audioChunks, { type: 'audio/webm' });
				const reader = new FileReader();
				reader.readAsDataURL(blob);
				reader.onloadend = async () => {
					await api({ action: "sendMessage", sender: user.name, receiver: partner, text: "ðŸŽ¤ Voice Note", media: reader.result, isRoom: isRoom });
					loadMessages();
				};
			};
			mediaRecorder.start();
			document.getElementById('voiceBtn').style.color = 'red';
		} catch (err) { alert("Mic access denied"); }
	}

	function stopRecording() {
		if(mediaRecorder && mediaRecorder.state !== "inactive") {
			mediaRecorder.stop();
			stream.getTracks().forEach(t => t.stop());
			document.getElementById('voiceBtn').style.color = '#8e8e93';
		}
	}

	const voiceBtn = document.getElementById('voiceBtn');
	voiceBtn.onmousedown = startRecording; voiceBtn.onmouseup = stopRecording;
	voiceBtn.ontouchstart = startRecording; voiceBtn.ontouchend = stopRecording;

	// --- MISC ---
	function startHeartbeat() { setInterval(() => { if(user) api({ action: "updateStatus", email: user.email }); }, 120000); }
	function openModal(id) { document.getElementById(id).style.display = 'flex'; }
	function closeModal(id) { document.getElementById(id).style.display = 'none'; }
	
	async function saveStaff() {
		const payload = {
			action: "addStaff",
			name: document.getElementById('newStaffName').value,
			email: document.getElementById('newStaffEmail').value,
			pass: document.getElementById('newStaffPass').value,
			job: document.getElementById('newStaffJob').value,
			phone: document.getElementById('newStaffPhone').value
		};
		await api(payload);
		closeModal('memberModal');
		loadAdminPanel();
	}

	async function checkNotifications() {
		const res = await api({ action: "getAnalytics" });
		if(!res.recentLogs || !user) return;
		const unread = res.recentLogs.filter(l => l.to === user.name && l.from !== partner);
		const area = document.getElementById('notificationArea');
		if(unread.length > 0) {
			const s = unread[unread.length-1].from;
			area.innerHTML = `<div class="glass-card" onclick="startChat('${s}')" style="background:var(--ios-blue); color:white; padding:10px;">New message from ${s}</div>`;
		} else area.innerHTML = "";
	}
	async function handleFileUpload(input) {
		if (!input.files || !input.files[0]) return;
		
		const file = input.files[0];
		const reader = new FileReader();
		
		// UI Feedback: Show user that something is happening
		const chatInput = document.getElementById('chatInput');
		const originalPlaceholder = chatInput.placeholder;
		chatInput.placeholder = "Uploading " + file.name + "...";
		chatInput.disabled = true;
	
		reader.onload = async (e) => {
			try {
				// Using POST via the api function to handle large data strings
				const response = await api({ 
					action: "sendMessage", 
					sender: user.name, 
					receiver: partner, 
					text: "ðŸ“Ž " + file.name, 
					media: e.target.result, 
					isRoom: isRoom 
				});
				
				if (response.status === "success") {
					// Reset UI
					chatInput.placeholder = originalPlaceholder;
					chatInput.disabled = false;
					input.value = ""; 
					loadMessages();
				} else {
					throw new Error("Server error");
				}
			} catch (err) {
				alert("Upload failed. The file may be too large for Google Sheets.");
				chatInput.placeholder = originalPlaceholder;
				chatInput.disabled = false;
			}
		};
		
		// Convert file to Base64 string
		reader.readAsDataURL(file);
	}

	lucide.createIcons();
</script>
</body>
</html>
